# Spec 005: Writer Agent and Draft Generation

## Context

DESIGN.md defines a multi-agent architecture where the Writer Agent is responsible for transforming conversation into structured documents. Currently, Quester has Orchestrator and Interviewer agents working, but lacks the Writer Agent and draft generation capability. This is a core feature required by PRD.md to deliver "structured outputs: outline, blog article, or exploration notes."

The design specifies that drafts should be updated continuously (not just at the end) and that the Writer Agent should run speculatively while the user is thinking/typing to optimize response time.

## Problem

- Current: No draft generation capability exists
- Result: Users cannot see progress or get structured outputs
- Limitation: Cannot implement divergence-convergence flow tangibly (draft completeness is a key signal)

## Goal

Implement Writer Agent and draft generation to enable:
1. Continuous draft updates as conversation progresses
2. Speculative execution while user is typing (background task)
3. API endpoint to retrieve draft for UI display
4. Draft persistence per topic in file system

## Non-Goals

- Context Builder utilities (shared across multiple agents, out of scope for this spec)
- Orchestrator integration (draft completeness metrics will be added later)
- In-chat draft display commands (UI-based viewing only)
- Reviewer Agent implementation (optional in DESIGN.md)
- Multi-format export (PDF, DOCX, etc.) - Markdown only for MVP
- Draft version history (overwrite approach per DESIGN.md)
- Real-time draft streaming to UI (async background generation only)

## Constraints

- Tech stack: TypeScript, Nuxt 3, OpenAI Responses API
- Backend-only LLM calls
- File-based persistence: `sessions/{sessionId}/drafts/{topicId}.md`
- Must not block user interaction (speculative execution)
- Maintain compatibility with existing Session/Topic data structures

---

## Implementation Plan

### 1. Writer Agent Structure

#### 1.1 Writer Agent Core

**Responsibility**: Transform conversation into structured documents

**Input**:
```typescript
{
  topicId: string,
  topicMessages: Message[],        // All messages for this topic
  relatedTopicDrafts: {             // For coherence
    [topicId: string]: {
      summary: string,
      keyPoints: string[]
    }
  },
  previousDraft?: Draft,            // Existing draft (if any)
  updateMode: 'incremental' | 'full_revision'
}
```

**Output**:
```typescript
{
  draft: {
    topicId: string,
    topicTitle: string,
    sections: Array<{
      title: string,
      content: string
    }>,
    completeness: number,           // 0-100
    missingAspects: string[],       // What's still needed
    updatedAt: string
  }
}
```

**Location**: `server/agents/writer.ts`

#### 1.2 Context Preparation

**Responsibility**: Prepare topic-specific context for Writer Agent (inline logic)

**Logic** (implemented in chat endpoint):
- Filter messages by target topic only
- Load related topic drafts (summaries + key points) if needed
- Attach previous draft version (if exists)
- Determine update mode (default: 'incremental')

### 2. Draft Data Structure

#### 2.1 Draft Type Definition

```typescript
interface Draft {
  topicId: string
  topicTitle: string
  sections: DraftSection[]
  completeness: number        // 0-100
  missingAspects: string[]
  updatedAt: string
}

interface DraftSection {
  title: string
  content: string             // Markdown
}
```

**Location**: Add to `types/index.ts`

#### 2.2 Draft File Format

**File path**: `sessions/{sessionId}/drafts/{topicId}.md`

**Format**:
```markdown
---
topicId: "abc123"
topicTitle: "Feature Design"
completeness: 75
missingAspects:
  - "Implementation timeline"
  - "Risk analysis"
updatedAt: "2025-10-06T12:34:56Z"
---

# Feature Design

## Background

[Content generated by Writer Agent...]

## Goals

[Content generated by Writer Agent...]
```

### 3. Speculative Execution Flow

#### 3.1 Execution Timing

**Trigger point**: Immediately after Interviewer sends question to user

```
User message → Orchestrator → Interviewer → Response sent to user
                                                      ↓
                                          [User thinking/typing 10-30s]
                                                      ↓
                                            Writer (background task)
                                                      ↓
                                              Draft updated
                                                      ↓
                              User answer arrives → Next turn (draft ready)
```

#### 3.2 Background Task Management

**Implementation approach**:
- Use async/await with Promise.race pattern
- Do not block chat response
- Track background task status per session
- Handle errors gracefully (log but don't fail chat)

**Location**: `server/utils/backgroundTasks.ts` (new file)

```typescript
interface BackgroundTask {
  sessionId: string
  taskType: 'draft_generation'
  topicId: string
  status: 'running' | 'completed' | 'failed'
  startedAt: string
  completedAt?: string
  error?: string
}
```

### 4. Draft API Endpoints

#### 4.1 Get Draft Endpoint

**Purpose**: Retrieve draft content for UI display

**Endpoint**: `GET /api/sessions/[sessionId]/drafts/[topicId]`

**Response**:
```typescript
{
  draft: Draft,
  exists: boolean
}
```

#### 4.2 List Drafts Endpoint

**Purpose**: List all drafts in a session

**Endpoint**: `GET /api/sessions/[sessionId]/drafts`

**Response**:
```typescript
{
  drafts: Array<{
    topicId: string,
    topicTitle: string,
    completeness: number,
    updatedAt: string
  }>
}
```

### 5. Draft Persistence

#### 5.1 File Operations

**Functions to implement**:
```typescript
// In server/utils/draftPersistence.ts (new file)

async function saveDraft(
  sessionId: string,
  draft: Draft
): Promise<void>

async function loadDraft(
  sessionId: string,
  topicId: string
): Promise<Draft | null>

async function listDrafts(
  sessionId: string
): Promise<DraftMetadata[]>

async function deleteDraft(
  sessionId: string,
  topicId: string
): Promise<void>
```

#### 5.2 Directory Structure

```
sessions/
  {sessionId}/
    session.json           # Existing
    drafts/                # New directory
      {topicId}.md         # One file per topic
      {topicId}.md
      ...
```

### 6. Error Handling

#### 6.1 Writer Agent Failures

- LLM timeout: Retry once, then log and skip
- Parsing error: Log and use previous draft version
- File write error: Log but don't fail chat

#### 6.2 Background Task Failures

- Never block user interaction
- Log all errors for debugging
- Gracefully degrade (chat continues without draft)

### 7. Testing Strategy

#### 7.1 Unit Tests

**Writer Agent**:
- [ ] Given conversation messages → generates valid draft structure
- [ ] Incremental mode → preserves existing sections
- [ ] Full revision mode → regenerates all sections
- [ ] Completeness calculation is reasonable (0-100)
- [ ] Missing aspects array is populated

**Draft Persistence**:
- [ ] Save draft → file created with correct format
- [ ] Load draft → parses frontmatter + content correctly
- [ ] List drafts → returns all drafts in session
- [ ] Delete draft → removes file

#### 7.2 Integration Tests

**End-to-end flow**:
- [ ] User conversation → draft automatically generated
- [ ] API GET /drafts/[topicId] → returns draft
- [ ] Multiple topics → multiple draft files created
- [ ] Session resume → drafts persist and reload

#### 7.3 Performance Tests

- [ ] Draft generation completes within 10s
- [ ] Background task does not block chat response
- [ ] File I/O does not cause noticeable delay

---

## Detailed Implementation Steps

### Step 1: Create Draft Type Definitions
1. Add `Draft`, `DraftSection`, `DraftMetadata` to `types/index.ts`
2. Add `BackgroundTask` type

### Step 2: Implement Draft Persistence
1. Create `server/utils/draftPersistence.ts`
2. Implement `saveDraft()`, `loadDraft()`, `listDrafts()`, `deleteDraft()`
3. Handle frontmatter parsing and generation
4. Add error handling for file operations

### Step 3: Implement Writer Agent
1. Create `server/agents/writer.ts`
2. Design prompt for structured document generation
3. Call OpenAI Responses API with structured output
4. Parse and validate response
5. Calculate completeness heuristic
6. Identify missing aspects

### Step 4: Implement Background Task System
1. Create `server/utils/backgroundTasks.ts`
2. Implement task queue/tracker
3. Add async execution wrapper
4. Handle errors gracefully

### Step 5: Integrate with Chat Flow
1. Modify `server/api/chat.post.ts`
2. Add inline context preparation (filter messages by topic)
3. Trigger Writer Agent after Interviewer response
4. Run in background (non-blocking)
5. Save draft to file system

### Step 6: Implement Draft API Endpoints
1. Create `server/api/sessions/[id]/drafts/[topicId].get.ts`
2. Create `server/api/sessions/[id]/drafts/index.get.ts`
3. Use draft persistence utilities to load and return data

### Step 7: Test and Verify
1. Unit test each component
2. Integration test end-to-end flow
3. Verify file persistence
4. Measure performance

---

## Success Criteria

- [ ] Writer Agent generates structured drafts from conversation
- [ ] Drafts persist to file system in Markdown format
- [ ] Drafts update continuously (not just at end)
- [ ] Background execution does not block chat
- [ ] API endpoints return draft data correctly
- [ ] Completeness metric is reasonable and useful
- [ ] All tests pass
- [ ] Performance: draft generation < 10s, no blocking

---

## Risks & Mitigation

### Risk 1: Draft Generation Too Slow
- **Cause**: Large conversation history + complex prompt
- **Mitigation**:
  - Optimize prompt length (focus on essentials)
  - Limit topicMessages to recent N messages
  - Use streaming if needed (future enhancement)

### Risk 2: Draft Quality Poor
- **Cause**: Insufficient context or unclear prompt
- **Mitigation**:
  - Include all topic-related messages (no limit for MVP)
  - Iterate on prompt with examples
  - Test with various conversation lengths

### Risk 3: Background Task Complexity
- **Cause**: Race conditions, error handling complexity
- **Mitigation**:
  - Keep it simple: single async call, no queue (MVP)
  - Log all errors, never crash
  - Document task lifecycle clearly

### Risk 4: File System Performance
- **Cause**: Many reads/writes during active session
- **Mitigation**:
  - Cache draft in memory during session (future enhancement)
  - For MVP: direct file I/O is acceptable (single user)

---

## Assumptions

1. Draft generation < 10s is acceptable (user is typing during this time)
2. Single topic active at a time (no parallel draft generation needed)
3. Markdown format is sufficient for MVP
4. Overwrite approach (no version history) is acceptable

---

## Future Enhancements (Out of Scope)

- Draft version history
- Multi-format export (PDF, DOCX)
- Real-time streaming updates to UI
- Draft diff view (show changes)
- Manual draft editing in UI
- Reviewer Agent for quality assessment
- Collaborative drafting (multi-user)

---

## Alignment with DESIGN.md

| DESIGN.md Section | Implementation |
|-------------------|----------------|
| 2.2 Writer Agent | `server/agents/writer.ts` |
| 3.2 Writer Context | Inline context preparation in chat endpoint |
| 4.1 Continuous Updates | Background task after each Interviewer response |
| 4.4 Storage | `sessions/{sessionId}/drafts/{topicId}.md` |

---

## References

- [PRD.md](../../PRD.md): Goal #8 - Structured outputs
- [DESIGN.md](../../DESIGN.md): Section 2.2, 3.2, 4 - Writer Agent design
- [ARCHITECTURE.md](../../ARCHITECTURE.md): File-based persistence
- [Spec 004](../004-multi-agent-architecture/README.md): Multi-agent foundation
