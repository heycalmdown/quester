# Spec 006: Draft UI with Three-Panel Layout

## Context

Spec 005 implemented the Writer Agent that generates structured Markdown drafts in the background. These drafts are stored in `sessions/{sessionId}/drafts/{topicId}.md` and accessible via API endpoints (`GET /api/sessions/[id]/drafts` and `GET /api/sessions/[id]/drafts/[topicId]`).

Currently, the UI has a two-panel layout: Chat (left) and Topic Backlog (right sidebar). Users cannot view the generated drafts because there is no frontend interface to display them.

PRD.md Goal #8 requires "structured outputs: outline, blog article, or exploration notes," which the Writer Agent now produces but are invisible to users.

## Problem

- Current: Drafts are generated but not visible in the UI
- Result: Users cannot see the structured output being created from their conversation
- Limitation: No way to track draft completeness or review content during conversation

## Goal

Transform the UI from a two-panel layout (Chat + Topics) into a three-panel layout (Chat, Topics, Drafts) to:
1. Display drafts generated by the Writer Agent
2. Show draft completeness percentage per topic
3. Allow users to select a topic and view its corresponding draft
4. Maintain conversation flow while providing access to structured outputs
5. Show all three panels simultaneously for better context awareness

## Non-Goals

- Draft editing functionality (read-only view only)
- Draft export to PDF/DOCX (Markdown display only)
- Draft version history or diff view
- Real-time draft streaming updates (poll-based updates acceptable)
- Draft sharing or collaboration features
- Mobile-optimized layout (desktop-first approach)

## Constraints

- Tech stack: Nuxt 3, Vue 3 Composition API, Nuxt UI components
- Must reuse existing API endpoints from Spec 005
- Maintain backward compatibility with existing session/topic data structures
- Keep UI simple and focused (no overwhelming feature density)
- Must work with file-based persistence (no database required)

---

## Implementation Plan

### 1. UI Structure Changes

#### 1.1 Current Layout (Two-Panel)

```
┌─────────────────────────────────────┬──────────────┐
│                                     │              │
│          Chat Messages              │    Topic     │
│                                     │   Backlog    │
│                                     │              │
│                                     │              │
│─────────────────────────────────────│              │
│          Chat Input                 │              │
└─────────────────────────────────────┴──────────────┘
```

#### 1.2 New Layout (Three Panels)

```
┌──────────────────┬──────────────┬─────────────────────┐
│                  │              │                     │
│   Chat Messages  │    Topic     │   Draft Viewer      │
│                  │   Backlog    │                     │
│                  │              │   (Selected Draft)  │
│                  │              │                     │
│──────────────────│              │                     │
│   Chat Input     │              │                     │
└──────────────────┴──────────────┴─────────────────────┘
    (40% width)      (20% width)       (40% width)
```

**Panel widths**:
- Chat Panel: 40% (left)
- Topics Panel: 20% (middle)
- Drafts Panel: 40% (right)

**Responsive behavior**:
- Desktop (≥1280px): Three panels side-by-side
- Tablet (768px-1279px): Two panels (Chat + Topics), Drafts hidden or accessible via toggle
- Mobile (<768px): Single panel with tab navigation (acceptable degradation)

### 2. Panel Components

#### 2.1 Chat Panel

**Responsibility**: Show conversation messages and input

**Content**:
- Message list (existing `ChatMessage` component)
- Chat input (existing `ChatInput` component)
- Session header (title, created date)

**Location**: Keep in `pages/index.vue` or extract to `components/ChatPanel.vue`

**State**:
- Uses `sessionStore.currentSession.messages`
- Handles `sendMessage` action

#### 2.2 Topics Panel

**Responsibility**: Show topic backlog and current topic

**Content**:
- Topic list with status indicators
- Current topic highlight
- Actions: "Discuss", "Mark Complete"
- Click topic to select it (loads corresponding draft in Drafts Panel)

**Location**: Refactor existing `components/TopicBacklog.vue` → `components/TopicsPanel.vue`

**State**:
- Uses `sessionStore.backlogTopics`
- Uses `sessionStore.currentTopic`
- Handles topic selection and completion

**Interaction**:
- Clicking a topic loads its draft in the Drafts Panel
- Current topic is visually highlighted

#### 2.3 Drafts Panel

**Responsibility**: Display selected topic's draft content

**Content**:
- Draft viewer (Markdown rendered as HTML)
- Topic title header
- Completeness percentage progress bar
- Last updated timestamp
- Missing aspects section (collapsible)
- Empty state: "Select a topic to view its draft"

**Location**: `components/DraftsPanel.vue` (new component)

**Layout**:
```
┌─────────────────────────────────────────────┐
│ Feature Design                   [75% ████▒]│
│ Last updated: 2 minutes ago                 │
├─────────────────────────────────────────────┤
│                                             │
│ ## Background                               │
│ [Content...]                                │
│                                             │
│ ## Goals                                    │
│ [Content...]                                │
│                                             │
│ ▼ Missing Aspects (2)                       │
│   - Implementation timeline                 │
│   - Risk analysis                           │
│                                             │
└─────────────────────────────────────────────┘
```

**State**:
- `selectedTopicId`: Currently selected topic for draft viewing (synced with Topics Panel)
- `currentDraft`: Full draft content (from API)

**Data flow**:
- When user clicks topic in Topics Panel → `selectedTopicId` updates → Drafts Panel fetches and displays corresponding draft

### 3. Draft Data Fetching

#### 3.1 Draft Store Integration

**Approach**: Extend `stores/session.ts` to manage draft state

**New state properties**:
```typescript
interface SessionState {
  // ... existing properties
  currentDraft: Draft | null        // Selected draft content
  selectedDraftTopicId: string | null
}
```

**New actions**:
```typescript
async fetchDraftByTopicId(topicId: string): Promise<void>
selectDraftTopic(topicId: string): void
```

#### 3.2 API Integration

**Endpoints to use** (already implemented in Spec 005):
- `GET /api/sessions/[sessionId]/drafts/[topicId]` → Get specific draft

**Fetching strategy**:
- Fetch draft content when user clicks a topic in Topics Panel
- Optional: Auto-refresh every 10s for the selected draft (detect background Writer Agent updates)
- Cache draft in store to avoid re-fetching when switching between topics

### 4. Panel Interaction Flow

#### 4.1 Topic Selection Flow

**User action**: Click topic in Topics Panel

**System behavior**:
1. Update `sessionStore.selectedDraftTopicId` to clicked topic ID
2. Call `sessionStore.fetchDraftByTopicId(topicId)`
3. Drafts Panel shows loading state
4. When draft loads, Drafts Panel renders draft content
5. If no draft exists, show empty state: "Draft is being generated. Check back soon!"

#### 4.2 Draft Update Detection

**Scenario**: User viewing draft while Writer Agent updates it in background

**Solution**:
- Show "last updated" timestamp in draft header
- Optional: Poll `GET /api/sessions/[id]/drafts/[topicId]` every 10s
- If `updatedAt` timestamp changes, show "Draft updated" indicator
- Provide "Refresh" button to reload latest version

### 5. Draft Content Rendering

#### 5.1 Markdown Rendering

**Library**: Use existing Nuxt Content or `marked` library

**Installation** (if not present):
```bash
pnpm add marked
```

**Rendering approach**:
```typescript
import { marked } from 'marked'

const renderedContent = computed(() => {
  if (!currentDraft.value) return ''
  const sections = currentDraft.value.sections
    .map(s => `## ${s.title}\n\n${s.content}`)
    .join('\n\n')
  return marked.parse(sections)
})
```

**Sanitization**: Use `DOMPurify` to prevent XSS (optional for MVP, drafts are AI-generated trusted content)

#### 5.2 Draft Metadata Display

**Components to show**:
- Topic title (header)
- Completeness percentage (progress bar)
- Last updated timestamp
- Missing aspects (bulleted list, collapsible section)

### 6. Edge Cases and Error Handling

#### 6.1 Empty States

**No session active**:
- Show: "Start a session to view drafts"
- Drafts Panel disabled/empty

**No topic selected**:
- Show: "Select a topic to view its draft"
- Drafts Panel shows placeholder

**Selected topic has no draft**:
- Show: "Draft is being generated. Check back soon!"

#### 6.2 API Failures

**Fetch draft fails**:
- Show error message in Drafts Panel
- Retry button
- Gracefully degrade (don't break entire UI)

#### 6.3 Background Draft Updates

**Scenario**: User is viewing draft while Writer Agent updates it in background

**Solution**:
- Show "last updated" timestamp in draft header
- Optional: Poll every 10s, show "Draft updated" indicator if timestamp changes
- Provide "Refresh" button to reload latest version

### 7. Component Structure

```
pages/
  index.vue                    # Main layout with three-panel grid
components/
  ChatPanel.vue                # Chat messages + input (optional extraction from index.vue)
  TopicsPanel.vue              # Topic backlog (refactored from TopicBacklog.vue)
  DraftsPanel.vue              # Draft viewer (NEW)
  ChatMessage.vue              # (existing, unchanged)
  ChatInput.vue                # (existing, unchanged)
stores/
  session.ts                   # Extended with draft fetching actions
```

### 8. Testing Strategy

#### 8.1 Component Tests

**ChatPanel.vue**:
- [ ] Renders messages correctly
- [ ] Sends messages via store action
- [ ] Shows loading state during send

**TopicsPanel.vue**:
- [ ] Renders topic list
- [ ] Highlights current topic
- [ ] Emits topic selection events for draft viewing
- [ ] "Discuss" and "Mark Complete" actions work

**DraftsPanel.vue**:
- [ ] Shows empty state when no topic selected
- [ ] Fetches draft when topic is selected
- [ ] Renders Markdown content as HTML
- [ ] Displays completeness percentage
- [ ] Shows missing aspects section
- [ ] Shows loading state during fetch

#### 8.2 Integration Tests

**End-to-end flow**:
- [ ] User starts session → all three panels visible
- [ ] User selects topic in Topics Panel → Drafts Panel loads corresponding draft
- [ ] User switches topics → Drafts Panel updates with new draft
- [ ] Background Writer Agent updates draft → user sees update indicator (if polling enabled)
- [ ] Chat and Topics panels work independently of Drafts Panel

#### 8.3 Visual Regression Tests

- [ ] Three-panel layout displays correctly on desktop
- [ ] Panel widths are proportional (40-20-40)
- [ ] Markdown rendering styled correctly
- [ ] Empty states look good
- [ ] Responsive behavior on tablet/mobile

---

## Detailed Implementation Steps

### Step 1: Extend Session Store
1. Add draft-related state to `stores/session.ts`:
   - `currentDraft: Draft | null`
   - `selectedDraftTopicId: string | null`
2. Implement `fetchDraftByTopicId(topicId: string)` action (calls `GET /api/sessions/[id]/drafts/[topicId]`)
3. Implement `selectDraftTopic(topicId: string)` action to update `selectedDraftTopicId` and fetch draft

### Step 2: Create Drafts Panel Component
1. Create `components/DraftsPanel.vue`
   - Render Markdown content using `marked`
   - Show metadata (topic title, completeness %, updated time, missing aspects)
   - Handle empty states (no topic selected, no draft exists, loading)
   - Add error handling UI

### Step 3: Refactor Topics Component
1. Rename `components/TopicBacklog.vue` → `components/TopicsPanel.vue`
2. Add click handler on topic items to call `sessionStore.selectDraftTopic(topicId)`
3. Update styling to indicate selected topic for draft viewing (separate from "current" topic)

### Step 4: Update Main Layout
1. Modify `pages/index.vue`:
   - Change grid layout from 2 columns to 3 columns (40%-20%-40%)
   - Add `<DraftsPanel>` as third column
   - Pass `selectedDraftTopicId` and `currentDraft` from store to DraftsPanel
   - Ensure responsive behavior (hide Drafts Panel on tablet/mobile)

### Step 5: Integrate Markdown Rendering
1. Install `marked` library: `pnpm add marked`
2. Configure `marked` options (if needed)
3. Render draft sections as HTML in `DraftsPanel.vue`
4. Apply basic styling to rendered Markdown (headings, lists, paragraphs)

### Step 6: Handle Edge Cases
1. Add empty state components in `DraftsPanel.vue`:
   - No session active
   - No topic selected
   - No draft for selected topic
2. Add error handling UI for API failures
3. Add loading states for async operations

### Step 7: Optional: Auto-refresh Polling
1. Add polling logic in `DraftsPanel.vue` (optional):
   - Poll `GET /api/sessions/[id]/drafts/[topicId]` every 10s
   - Compare `updatedAt` timestamp
   - Show "Draft updated" indicator if changed
   - Provide "Refresh" button

### Step 8: Polish and Test
1. Test panel layout and sizing
2. Test topic selection → draft loading flow
3. Verify Markdown rendering quality
4. Test responsive layout (desktop/tablet/mobile)
5. Add loading spinners and error messages

---

## Success Criteria

- [ ] UI has three panels: Chat, Topics, Drafts displayed simultaneously
- [ ] Chat panel shows conversation (existing functionality preserved)
- [ ] Topics panel shows topic backlog (existing functionality preserved)
- [ ] Clicking a topic in Topics panel loads its draft in Drafts panel
- [ ] Draft content renders Markdown correctly as formatted HTML
- [ ] Drafts panel shows completeness percentage and metadata
- [ ] Empty states show helpful messages
- [ ] API failures are handled gracefully
- [ ] Panel layout is responsive (40-20-40 on desktop)
- [ ] No breaking changes to existing features

---

## Risks & Mitigation

### Risk 1: Markdown Rendering Performance
- **Cause**: Large drafts with complex Markdown syntax
- **Mitigation**:
  - Use `marked` (fast, widely-used library)
  - Lazy render: only render when draft is selected
  - For MVP: acceptable performance (single-user, small drafts)

### Risk 2: Stale Draft Content
- **Cause**: User viewing draft while Writer Agent updates it in background
- **Mitigation**:
  - Show "last updated" timestamp
  - Add "Refresh" button for manual reload
  - Future enhancement: auto-refresh polling

### Risk 3: UI Complexity Overload
- **Cause**: Three panels may feel overwhelming with too much information
- **Mitigation**:
  - Keep each panel focused on one task
  - Use clear visual hierarchy
  - Drafts panel only shows content when topic is selected (empty by default)

### Risk 4: Mobile Layout Degradation
- **Cause**: Three-panel layout does not fit on small screens
- **Mitigation**:
  - Desktop-first approach (acceptable for MVP)
  - Hide Drafts panel on tablet/mobile
  - Future enhancement: tab navigation or drawer for mobile

---

## Assumptions

1. Users will primarily use Quester on desktop (tablet/mobile is secondary)
2. Draft count per session is low (<10 topics, <10 drafts)
3. Markdown rendering performance is acceptable for typical draft sizes (<5000 words)
4. Manual refresh is acceptable (no real-time streaming required)

---

## Future Enhancements (Out of Scope)

- Draft editing in UI
- Draft export to PDF/DOCX
- Draft version history and diff view
- Real-time draft streaming updates
- Collaborative draft commenting
- Draft search and filtering
- Dark mode for draft viewer
- Syntax highlighting for code blocks in drafts
- Draft templates and presets

---

## Alignment with PRD.md

| PRD.md Section | Implementation |
|----------------|----------------|
| Goal #8: Structured outputs | Drafts panel displays structured Markdown drafts |
| User Journey Step 8 | Final outline and draft visible in Drafts panel |
| Key Features: Outputs | Read-only Markdown draft viewer in dedicated panel |

---

## References

- [PRD.md](../../PRD.md): Goal #8 - Structured outputs
- [Spec 005](../005-writer-agent/README.md): Writer Agent and draft generation
- [ARCHITECTURE.md](../../ARCHITECTURE.md): File-based persistence
- [marked](https://marked.js.org/): Markdown to HTML converter library
